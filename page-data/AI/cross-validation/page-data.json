{"componentChunkName":"component---src-templates-blog-post-js","path":"/AI/cross-validation/","result":{"data":{"site":{"siteMetadata":{"title":"Gunu's AI Log","author":"[Gunu]","siteUrl":"https://gunu441.github.io","comment":{"disqusShortName":"","utterances":"gunu9441/gunu9441.github.io"},"sponsor":{"buyMeACoffeeId":"gunu9441"}}},"markdownRemark":{"id":"ac2c8a96-461c-5c80-a66d-2d5d04beaaf5","excerpt":"이번 시간에는 cross validation에 대해서 알아보도록 하겠습니다!✨ cross validation은 평상시 데이터가 부족할 때 사용한다고만 알고 있었는데, 이번에 제대로 알아보고자 공부해보았습니다😎 What is Cross validation…","html":"<p>    이번 시간에는 cross validation에 대해서 알아보도록 하겠습니다!✨ cross validation은 평상시 데이터가 부족할 때 사용한다고만 알고 있었는데, 이번에 제대로 알아보고자 공부해보았습니다😎</p>\n<h2 id=\"what-is-cross-validation\" style=\"position:relative;\"><a href=\"#what-is-cross-validation\" aria-label=\"what is cross validation permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>What is Cross validation?</h2>\n<p>    보통 큰 데이터 셋이 있다면 실제 모델을 평가하기 위해서 데이터를 훈련용, 검증용, 테스트용 이렇게 세 가지로 분리하는 것이 일반적입니다. 훈련용 데이터로는 <strong>데이터 훈련</strong>을, 검증용 데이터로는 <strong>모델의 성능을 조절</strong>하게 됩니다. 모델이 <strong>과적합이 되고 있는지 판단</strong>하거나 <strong>훈련용 데이터로 훈련을 시킨 모델의 정확도</strong>를 <strong>검증용 데이터를 사용하여 검증</strong>하면서 <strong>하이퍼 파라미터를 조정</strong>(<strong>hyper parameter tuning</strong>)을 하게 됩니다.</p>\n<p>    이런 과정이 끝나게 된다면 <strong>검증용 데이터에 대해서 일정 부분 최적화가 진행</strong>되었기 때문에 <strong>검증용 데이터로 모델을 평가하는 것이 적합하지 않습니다</strong>. 이에 <strong>테스트 데이터를 통해</strong> 모델의 진짜 <strong>성능을 평가</strong>하게 됩니다.</p>\n<p>평상시 대회에서는, test data의 label은 모르는 상태에서 data의 label을 맞춰야 하므로 주어진 <strong>training dataset을 training set과 validation set을 나눠야</strong>합니다. 하지만 <em>training dataset이 작아서 traning set과 validation set으로 나누지 못하는 경우</em> <strong>cross validation을 사용</strong>합니다. 오늘 알아볼 cross validation에는 <strong>K-Fold cross validation</strong>, <strong>Startified-K-Fold cross validation</strong>이 있습니다.</p>\n<h2 id=\"k-fold-cross-validation\" style=\"position:relative;\"><a href=\"#k-fold-cross-validation\" aria-label=\"k fold cross validation permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>K-Fold cross validation</h2>\n<p>    <strong>K-Fold cross validation</strong>은 전체 데이터 셋을 <strong>training set과 test set</strong>으로 나눈 뒤, <strong>training set을 다시 training set과 validation set</strong>으로 나누는데 이 때, <strong>k개의 fold</strong>로 나누게 됩니다. <strong>k개 의 fold가 k번 동안 차례대로 validation set이 되고 나머지 fold는 training set</strong>이 됩니다. 아래의 그림은 방금한 설명을 도식화 한 것입니다.</p>\n<p align=\"center\">\n    &lt; How to implement cross validation? &gt;\n</p>\n<p align=\"center\">\n   <span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 1200px; \">\n      <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 70%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAOCAYAAAAvxDzwAAAACXBIWXMAAAsTAAALEwEAmpwYAAACs0lEQVQ4y32T63PaRhTF+f8/pl8y6Uw/N5686qaxMfUjKdgG4+BH/MIGJDAS0kqrBxLoAfy6UuIwmWa6M0f3Snfn3LP3rCqotVqtCIII3w9/QFBiiu+F6NoQXR+ta0HwDeE3BIThlMoToTMNsQNPwccO/TK3fInte2WuWybaxCjroqjLKaar4AQqhmUu/HhN2Ege+JBeUk2vqGZXvJ92+F3/WOKNOKa2uGEnv2Y7+0ItueL1Tcyv7ZRf9sc82x3xoj1n8zZbE+YsS2QsVFyVMV3m37Gufd2XLFbMsiWzdEGc5GWe5CsqBVmBOJoRqlnM52k5u1k8J4pipmHEbJao2rT8VrxP1azyPOdnq/KUjE2Lh/4ARwbc3vcwLIfho0FfH2LaLg+DgYoOA2WM/jjGceV30idRBSpSuqU7e7cRG0ceLeHyUZ7QiXrU5R2fxDWfQ51d+1xFrXxveHfKFJfFT1RWhBD4yvK9UY9X3Q4HY8Fv9S7Ve4sd+zNbRouG7PJ2eEjD7fLhsU3V6mBJhzzLflBXKvR9n2kU0QruqYkTjt0JL8809jWb6nDAX70Hmp5G1W6rPT32xCUH8oqJI3AdB8MwsCwL0zRxXVcptG08z6Opum+PT+nMdbbNw7LBm47DRtOmMRkrZac05YDdyTkH4kt55ELhYrEoUcyziJXihkdKYd2940/jhKOwz7tRi3/UMXfEBVXRZvte8HzfYavrUHXa1NxzLFewUIRfXVkWj8IdKoVcKSUNccOmfkQ71njbq3OoDKlZZ2yNVBPZ449hk7o14uWJycapieVFBcV/TUnTlEx1MhIPbWYzyQIGsYWRegznTolxIrkLdPqe4FwLONN9rP4FmXmJr3UIFJLxBYnore/h/658iSckUjgKE6LiP7/+RNz9G721yeD4HeFNjVhv8y+Q/RGgnQ+vTQAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"assets 2021 08 26 1\" title=\"assets 2021 08 26 1\" src=\"/static/20f00d5a70c144f0ed39ca590f25343a/c1b63/1.png\" srcset=\"/static/20f00d5a70c144f0ed39ca590f25343a/5a46d/1.png 300w,\n/static/20f00d5a70c144f0ed39ca590f25343a/0a47e/1.png 600w,\n/static/20f00d5a70c144f0ed39ca590f25343a/c1b63/1.png 1200w,\n/static/20f00d5a70c144f0ed39ca590f25343a/d61c2/1.png 1800w,\n/static/20f00d5a70c144f0ed39ca590f25343a/565cc/1.png 1806w\" sizes=\"(max-width: 1200px) 100vw, 1200px\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\" loading=\"lazy\">\n    </span>\n</p>\n<p>    해당 그림을 보게되면 <strong>ALL Data(모든 데이터)를 Training data와 Test data</strong>로 나눈 것을 볼 수 있습니다. 이후 <strong>5-Fold cross validation을 사용</strong>했는데 <strong>5-Fold 이기 때문에 5번 동안 5개의 Fold가 한번씩 validation set이 되며 진행</strong>됩니다(나머지 <strong>4개의 fold는 학습데이터</strong>가 됩니다.). 이렇게 학습하면서 검증을 하게 되며 학습이 끝난 이후에 <strong>Test data를 통해 마지막 evaluation</strong>을 거치게 됩니다.</p>\n<h2 id=\"code\" style=\"position:relative;\"><a href=\"#code\" aria-label=\"code permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Code</h2>\n<p>    <strong>사이킷런을 사용</strong>하면 <strong>K-Fold cross validation을 손쉽게 구현</strong>할 수 있습니다. 아래의 코드와 같이 사용할 수 있습니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token keyword\">from</span> sklearn<span class=\"token punctuation\">.</span>model_selection <span class=\"token keyword\">import</span> KFold\n\nX<span class=\"token operator\">=</span>np<span class=\"token punctuation\">.</span>array<span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span>\n    <span class=\"token punctuation\">[</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">2</span><span class=\"token punctuation\">,</span> <span class=\"token number\">3</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">[</span><span class=\"token number\">11</span><span class=\"token punctuation\">,</span><span class=\"token number\">12</span><span class=\"token punctuation\">,</span><span class=\"token number\">13</span><span class=\"token punctuation\">,</span><span class=\"token number\">14</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">[</span><span class=\"token number\">21</span><span class=\"token punctuation\">,</span><span class=\"token number\">22</span><span class=\"token punctuation\">,</span><span class=\"token number\">23</span><span class=\"token punctuation\">,</span><span class=\"token number\">24</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">[</span><span class=\"token number\">31</span><span class=\"token punctuation\">,</span><span class=\"token number\">32</span><span class=\"token punctuation\">,</span><span class=\"token number\">33</span><span class=\"token punctuation\">,</span><span class=\"token number\">34</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">[</span><span class=\"token number\">41</span><span class=\"token punctuation\">,</span><span class=\"token number\">42</span><span class=\"token punctuation\">,</span><span class=\"token number\">43</span><span class=\"token punctuation\">,</span><span class=\"token number\">44</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">[</span><span class=\"token number\">51</span><span class=\"token punctuation\">,</span><span class=\"token number\">52</span><span class=\"token punctuation\">,</span><span class=\"token number\">53</span><span class=\"token punctuation\">,</span><span class=\"token number\">54</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">[</span><span class=\"token number\">61</span><span class=\"token punctuation\">,</span><span class=\"token number\">62</span><span class=\"token punctuation\">,</span><span class=\"token number\">63</span><span class=\"token punctuation\">,</span><span class=\"token number\">64</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">[</span><span class=\"token number\">71</span><span class=\"token punctuation\">,</span><span class=\"token number\">72</span><span class=\"token punctuation\">,</span><span class=\"token number\">73</span><span class=\"token punctuation\">,</span><span class=\"token number\">74</span><span class=\"token punctuation\">]</span>\n<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n\ny<span class=\"token operator\">=</span>np<span class=\"token punctuation\">.</span>array<span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n\nsplits <span class=\"token operator\">=</span> KFold<span class=\"token punctuation\">(</span>n_splits<span class=\"token operator\">=</span><span class=\"token number\">5</span><span class=\"token punctuation\">,</span> random_state<span class=\"token operator\">=</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span> shuffle<span class=\"token operator\">=</span><span class=\"token boolean\">False</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token keyword\">for</span> fold<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span>train_idx<span class=\"token punctuation\">,</span>val_idx<span class=\"token punctuation\">)</span> <span class=\"token keyword\">in</span> <span class=\"token builtin\">enumerate</span><span class=\"token punctuation\">(</span>splits<span class=\"token punctuation\">.</span>split<span class=\"token punctuation\">(</span>np<span class=\"token punctuation\">.</span>arange<span class=\"token punctuation\">(</span><span class=\"token builtin\">len</span><span class=\"token punctuation\">(</span>X<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n\tX_train<span class=\"token punctuation\">,</span> X_validate <span class=\"token operator\">=</span> X<span class=\"token punctuation\">[</span>train_idx<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> X<span class=\"token punctuation\">[</span>val_idx<span class=\"token punctuation\">]</span>\n  y_train<span class=\"token punctuation\">,</span> y_validate <span class=\"token operator\">=</span> y<span class=\"token punctuation\">[</span>train_idx<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> y<span class=\"token punctuation\">[</span>val_idx<span class=\"token punctuation\">]</span></code></pre></div>\n<p>    <code class=\"language-text\">X</code>라는 독립 변수이며, <code class=\"language-text\">y</code>는 종속변수 입니다. <code class=\"language-text\">X</code>와 <code class=\"language-text\">y</code>를 <code class=\"language-text\">n_splits</code>개의 fold로 나누어 <code class=\"language-text\">n_splits</code>번 만큼 training과 validation이 진행 됩니다. 그림과 같은 방법으로 K-Fold를 구현할 수 있습니다.</p>\n<p>    K-Fold cross validation의 기본 코드을 살펴보았으니 K-Fold cross validation을 실제로 pytorch에서 어떤 구조로 구현되는지 살펴 보겠습니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token comment\"># k-fold</span>\n<span class=\"token keyword\">for</span> fold<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span>train_ids<span class=\"token punctuation\">,</span> test_ids<span class=\"token punctuation\">)</span> <span class=\"token keyword\">in</span> <span class=\"token builtin\">enumerate</span><span class=\"token punctuation\">(</span>kfold<span class=\"token punctuation\">.</span>split<span class=\"token punctuation\">(</span>dataset<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n<span class=\"token comment\"># epoch</span>\n\t<span class=\"token keyword\">for</span> epoch <span class=\"token keyword\">in</span> <span class=\"token builtin\">range</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span> num_epochs<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n<span class=\"token comment\"># trainloader</span>\n\t\t<span class=\"token keyword\">for</span> i<span class=\"token punctuation\">,</span> data <span class=\"token keyword\">in</span> <span class=\"token builtin\">enumerate</span><span class=\"token punctuation\">(</span>trainloader<span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span></code></pre></div>\n<p>    <code class=\"language-text\">kfold</code>를 먼저 사용하여 첫 for문을 돌린 이후, 해당 <code class=\"language-text\">kfold</code>를 통해 정해진 training dataset을 통해 epoch를 돌립니다. 또한, dataloader를 사용하여 정해진 batch-size대로 data를 받아와서 정해진 epoch 만큼 k번 돌아가게 됩니다. 1개의 fold 당 <code class=\"language-text\">num_epochs</code>만큼 돌기 때문에 전체 epoch는 <code class=\"language-text\">num_epochs</code>* <code class=\"language-text\">fold</code>가 됩니다.</p>\n<p>    아래는 classification task에 cross validation을 적용한 code입니다.</p>\n<p>link: <a href=\"https://github.com/gunu9441/AI/blob/main/7.CNN/Deep_CNN_MNIST_using_cross_validation.ipynb\">https://github.com/gunu9441/AI/blob/main/7.CNN/Deep<em>CNN</em>MNIST<em>using</em>cross_validation.ipynb</a></p>\n<p>다음은 <code class=\"language-text\">SubsetRandomSampler</code>를 이해하고자 pytorch documentation에 있는 source를 가져온 것입니다. 아래의 코드에 대해 살펴보겠습니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token punctuation\">[</span>docs<span class=\"token punctuation\">]</span><span class=\"token keyword\">class</span> <span class=\"token class-name\">SubsetRandomSampler</span><span class=\"token punctuation\">(</span>Sampler<span class=\"token punctuation\">[</span><span class=\"token builtin\">int</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    <span class=\"token triple-quoted-string string\">r\"\"\"Samples elements randomly from a given list of indices, without replacement.\n\n    Args:\n        indices (sequence): a sequence of indices\n        generator (Generator): Generator used in sampling.\n    \"\"\"</span>\n    indices<span class=\"token punctuation\">:</span> Sequence<span class=\"token punctuation\">[</span><span class=\"token builtin\">int</span><span class=\"token punctuation\">]</span>\n\n    <span class=\"token keyword\">def</span> <span class=\"token function\">__init__</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">,</span> indices<span class=\"token punctuation\">:</span> Sequence<span class=\"token punctuation\">[</span><span class=\"token builtin\">int</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> generator<span class=\"token operator\">=</span><span class=\"token boolean\">None</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span><span class=\"token operator\">></span> <span class=\"token boolean\">None</span><span class=\"token punctuation\">:</span>\n        self<span class=\"token punctuation\">.</span>indices <span class=\"token operator\">=</span> indices\n        self<span class=\"token punctuation\">.</span>generator <span class=\"token operator\">=</span> generator\n\n    <span class=\"token keyword\">def</span> <span class=\"token function\">__iter__</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span><span class=\"token operator\">></span> Iterator<span class=\"token punctuation\">[</span><span class=\"token builtin\">int</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">:</span>\n        <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">.</span>indices<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span> <span class=\"token keyword\">for</span> i <span class=\"token keyword\">in</span> torch<span class=\"token punctuation\">.</span>randperm<span class=\"token punctuation\">(</span><span class=\"token builtin\">len</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">.</span>indices<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> generator<span class=\"token operator\">=</span>self<span class=\"token punctuation\">.</span>generator<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n\n    <span class=\"token keyword\">def</span> <span class=\"token function\">__len__</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span><span class=\"token operator\">></span> <span class=\"token builtin\">int</span><span class=\"token punctuation\">:</span>\n        <span class=\"token keyword\">return</span> <span class=\"token builtin\">len</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">.</span>indices<span class=\"token punctuation\">)</span></code></pre></div>\n<p>    <code class=\"language-text\">indices</code> parameter에 a set of <code class=\"language-text\">index</code>가 들어 가므로 <code class=\"language-text\">__iter__</code>에 <code class=\"language-text\">len(self.indices)</code>에 a set of <code class=\"language-text\">index</code>의 갯수가 들어가게 됩니다. 이후, <code class=\"language-text\">torch.randperm()</code>의 parameter로 들어가게 되어 <code class=\"language-text\">len(indices)</code> 크기의 배열에 <code class=\"language-text\">len(indices)</code>미만의 숫자들이 중복 없이 정렬되게 됩니다. 이를 통해 0번째 index부터 <code class=\"language-text\">len(indices)-1</code>까지 차례대로 for문을 통해 가져와서 indices안에 있는 값들을 뽑아서 return하게 됩니다. 즉, random하게 a set of <code class=\"language-text\">index</code>안에 있는 <code class=\"language-text\">index</code>들을 뽑아내기 위해 <code class=\"language-text\">SubsetRandomSampler</code>를 사용하는 것입니다. 이 <code class=\"language-text\">SubsetRandomSampler</code> 덕분에 <code class=\"language-text\">torch.utils.data.Dataloader</code>를 사용할 때 <code class=\"language-text\">shuffle = True</code><strong>를 사용하지 않아도</strong> 됩니다.</p>\n<h2 id=\"startified-k-fold-cross-validation\" style=\"position:relative;\"><a href=\"#startified-k-fold-cross-validation\" aria-label=\"startified k fold cross validation permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Startified-K-Fold cross validation</h2>\n<p>    <strong>Startified-K-Fold cross validation</strong>은 <strong>하나의 fold안</strong>으로 들어갈 <strong>label들의 종류가 골고루</strong> 들어갈 수 있도록 조정해주는 역할까지 수행합니다. <code class=\"language-text\">StartifiedKFold</code>의 사용방법은 아래와 같습니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token keyword\">import</span> numpy <span class=\"token keyword\">as</span> np\n<span class=\"token keyword\">from</span> sklearn<span class=\"token punctuation\">.</span>model_selection <span class=\"token keyword\">import</span> StratifiedKFold\n<span class=\"token keyword\">from</span> sklearn<span class=\"token punctuation\">.</span>model_selection <span class=\"token keyword\">import</span> KFold\n\nX<span class=\"token operator\">=</span>np<span class=\"token punctuation\">.</span>array<span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span>\n    <span class=\"token punctuation\">[</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">2</span><span class=\"token punctuation\">,</span> <span class=\"token number\">3</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">[</span><span class=\"token number\">11</span><span class=\"token punctuation\">,</span><span class=\"token number\">12</span><span class=\"token punctuation\">,</span><span class=\"token number\">13</span><span class=\"token punctuation\">,</span><span class=\"token number\">14</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">[</span><span class=\"token number\">21</span><span class=\"token punctuation\">,</span><span class=\"token number\">22</span><span class=\"token punctuation\">,</span><span class=\"token number\">23</span><span class=\"token punctuation\">,</span><span class=\"token number\">24</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">[</span><span class=\"token number\">31</span><span class=\"token punctuation\">,</span><span class=\"token number\">32</span><span class=\"token punctuation\">,</span><span class=\"token number\">33</span><span class=\"token punctuation\">,</span><span class=\"token number\">34</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">[</span><span class=\"token number\">41</span><span class=\"token punctuation\">,</span><span class=\"token number\">42</span><span class=\"token punctuation\">,</span><span class=\"token number\">43</span><span class=\"token punctuation\">,</span><span class=\"token number\">44</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">[</span><span class=\"token number\">51</span><span class=\"token punctuation\">,</span><span class=\"token number\">52</span><span class=\"token punctuation\">,</span><span class=\"token number\">53</span><span class=\"token punctuation\">,</span><span class=\"token number\">54</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">[</span><span class=\"token number\">61</span><span class=\"token punctuation\">,</span><span class=\"token number\">62</span><span class=\"token punctuation\">,</span><span class=\"token number\">63</span><span class=\"token punctuation\">,</span><span class=\"token number\">64</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">[</span><span class=\"token number\">71</span><span class=\"token punctuation\">,</span><span class=\"token number\">72</span><span class=\"token punctuation\">,</span><span class=\"token number\">73</span><span class=\"token punctuation\">,</span><span class=\"token number\">74</span><span class=\"token punctuation\">]</span>\n<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n\ny<span class=\"token operator\">=</span>np<span class=\"token punctuation\">.</span>array<span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span><span class=\"token number\">3</span><span class=\"token punctuation\">,</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span><span class=\"token number\">2</span><span class=\"token punctuation\">,</span><span class=\"token number\">3</span><span class=\"token punctuation\">,</span><span class=\"token number\">2</span><span class=\"token punctuation\">,</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n\nstratifiedkfold <span class=\"token operator\">=</span> StratifiedKFold<span class=\"token punctuation\">(</span>n_splits<span class=\"token operator\">=</span><span class=\"token number\">2</span><span class=\"token punctuation\">,</span>random_state<span class=\"token operator\">=</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span>shuffle<span class=\"token operator\">=</span><span class=\"token boolean\">False</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span>X<span class=\"token punctuation\">.</span>shape<span class=\"token punctuation\">,</span> y<span class=\"token punctuation\">.</span>shape<span class=\"token punctuation\">)</span>\n\n<span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"\\nStratifiedKFold**************\"</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">for</span> train_index<span class=\"token punctuation\">,</span> validate_index <span class=\"token keyword\">in</span> stratifiedkfold<span class=\"token punctuation\">.</span>split<span class=\"token punctuation\">(</span>X<span class=\"token punctuation\">,</span>y<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"train index:\"</span><span class=\"token punctuation\">,</span> train_index<span class=\"token punctuation\">,</span> <span class=\"token string\">\"validate index:\"</span><span class=\"token punctuation\">,</span> validate_index<span class=\"token punctuation\">)</span>\n    X_train<span class=\"token punctuation\">,</span> X_validate <span class=\"token operator\">=</span> X<span class=\"token punctuation\">[</span>train_index<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> X<span class=\"token punctuation\">[</span>validate_index<span class=\"token punctuation\">]</span>\n    y_train<span class=\"token punctuation\">,</span> y_validate <span class=\"token operator\">=</span> y<span class=\"token punctuation\">[</span>train_index<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> y<span class=\"token punctuation\">[</span>validate_index<span class=\"token punctuation\">]</span>\n    <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"train data\"</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span>X_train<span class=\"token punctuation\">,</span> y_train<span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"validate data\"</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span>X_validate<span class=\"token punctuation\">,</span> y_validate<span class=\"token punctuation\">)</span></code></pre></div>\n<p>다음의 코드의 결과는 아래와 같습니다.</p>\n<p align=\"center\">\n    &lt; Result &gt;\n</p>\n<p align=\"center\">\n   <span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 356px; \">\n      <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 106.33333333333333%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAVCAYAAABG1c6oAAAACXBIWXMAAAsTAAALEwEAmpwYAAABo0lEQVQ4y53UV47DMAwEUF8qvffe738WBk8AF0ayQJx8CJRtacQpcrVcLmOxWMR8Po/1eh3j8Tja7XZ0Op230e12P45qNBrFcDgsYzAYxHQ6LfW/xQnswDz0tVbb7TYul0vp8nq9xv1+j9PpFMfjsdTD4VA6N9/v93+HYqKJyWRS6mw2i16vFxUgi1EGlh1aYNhgWLfb7cp3B6xWq8DOPtVzv9+ParPZxPl8Dp1mtbnVar1Ry3dZ61S9K5RtRhkdnT4ej0I9F3xjSDEFhdvtVrRKDVUf0yyU6NMEuCIuMPqgb254T5+ME10bAdIM3bqbslnXKOcZnY+UAWQFqttvdHujrCsguuS0DOqqHuamo5KxjAsgc8bQjqYqSdIYQ95e52rpEE2xsVFkBDTvtgpUzZwKOzaesVPtSeNKsHXgpQ201E393n5F2YnAsiMn0rKJKa+hL4BpSgLp0nOa8pPLQNJlYDTVOV2Y5rDGwUYXSDrtGqLuI/fUdLARIFN0pEOxcY+B1ynXtfp4U1ADgi5g0QGYf5ufrh6gNMRcsEUH9cxiUw2fCiXU4c8p0UEAAAAASUVORK5CYII='); background-size: cover; display: block;\"></span>\n  <img class=\"gatsby-resp-image-image\" alt=\"assets 2021 08 26 2\" title=\"assets 2021 08 26 2\" src=\"/static/0e09c364afa8bd199f1ab4c615463eb5/50ac3/2.png\" srcset=\"/static/0e09c364afa8bd199f1ab4c615463eb5/5a46d/2.png 300w,\n/static/0e09c364afa8bd199f1ab4c615463eb5/50ac3/2.png 356w\" sizes=\"(max-width: 356px) 100vw, 356px\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\" loading=\"lazy\">\n    </span>\n</p>\n<p>    위의 결과를 보게되면 label 값이 골고루 들어갈 수 있도록 분배 된 것을 볼 수 있습니다.</p>\n<h2 id=\"summary\" style=\"position:relative;\"><a href=\"#summary\" aria-label=\"summary permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Summary</h2>\n<ul>\n<li><code class=\"language-text\">torch.utils.data.Dataloader</code>를 사용해도 모든 데이터를 batch<em>size로 나눠서 mini</em>batch로 만들어 사용하므로 <strong>한 epoch안에서 반드시 모든 데이터를 사용</strong>하게 됩니다.</li>\n<li><strong>k-Fold cross validation</strong>은 <strong>k번 동한 for문</strong>을 돌며 <strong>dataset을 k fold개 만큼 나누게</strong> 됩니다. 또한, <strong>k-1개의 fold를 사용하여 training set</strong>를 만들고 <strong>1개의 fold를 사용하여 validation set</strong>을 만듭니다. <strong>이 과정을 k번 동안 반복</strong>하며 학습과 검증을 k번 진행합니다.</li>\n<li><code class=\"language-text\">SubsetRandomSampler</code>를 사용하면 <code class=\"language-text\">torch.utils.data.Dataloader</code>의 <code class=\"language-text\">shuffle=True</code>를 사용하지 않아도 됩니다.</li>\n<li><code class=\"language-text\">shuffle = True</code>를 사용해서 <code class=\"language-text\">KFold</code>를 사용할 경우, k-Fold로 <strong>split하기 전에 먼저 전체 데이터를 한 번(!) shuffle을 수행</strong>합니다. <code class=\"language-text\">random_state</code>는 <code class=\"language-text\">random seed와 같은 개념</code>입니다.</li>\n</ul>\n<p>이것으로 이번 포스트를 마무리하겠습니다.</p>\n<p>감사합니다😉👍</p>\n<h2 id=\"reference\" style=\"position:relative;\"><a href=\"#reference\" aria-label=\"reference permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Reference</h2>\n<hr>\n<ul>\n<li>The description of <code class=\"language-text\">train_test_split</code> and <code class=\"language-text\">KFold()</code>: <a href=\"https://m.blog.naver.com/PostView.naver?isHttpsRedirect=true&#x26;blogId=gustn3964&#x26;logNo=221431914515\">https://m.blog.naver.com/PostView.naver?isHttpsRedirect=true&#x26;blogId=gustn3964&#x26;logNo=221431914515</a></li>\n<li>The code of <code class=\"language-text\">StartifiedKFold</code> and <code class=\"language-text\">KFold</code> <a href=\"https://swlock.blogspot.com/2019/01/scikit-learn-cross-validation-iterators.html?m=1\">https://swlock.blogspot.com/2019/01/scikit-learn-cross-validation-iterators.html?m=1</a></li>\n<li>Cross validation(Keras): <a href=\"https://m.blog.naver.com/nywoo19/221970913783\">https://m.blog.naver.com/nywoo19/221970913783</a></li>\n<li>Python yield: <a href=\"https://dojang.io/mod/page/view.php?id=2412\">https://dojang.io/mod/page/view.php?id=2412</a></li>\n<li>Cross validation sample github: <a href=\"https://github.com/gucci-j/pytorch-imdb-cv/blob/master/src/load_data.py\">https://github.com/gucci-j/pytorch-imdb-cv/blob/master/src/load_data.py</a></li>\n<li>Pytorch cross validation: <a href=\"https://www.machinecurve.com/index.php/2021/02/03/how-to-use-k-fold-cross-validation-with-pytorch/\">https://www.machinecurve.com/index.php/2021/02/03/how-to-use-k-fold-cross-validation-with-pytorch/</a></li>\n<li>Basic concept of dataset: <a href=\"https://wikidocs.net/60021\">https://wikidocs.net/60021</a></li>\n<li>Pytorch K-fold: <a href=\"https://medium.com/dataseries/k-fold-cross-validation-with-pytorch-and-sklearn-d094aa00105f\">https://medium.com/dataseries/k-fold-cross-validation-with-pytorch-and-sklearn-d094aa00105f</a></li>\n<li>randperm: <a href=\"https://bigdatadiary0819.tistory.com/60\">https://bigdatadiary0819.tistory.com/60</a></li>\n<li>KFold <code class=\"language-text\">shuffle=True</code>: <a href=\"https://stackoverflow.com/questions/12237127/how-to-use-shuffle-in-kfold-in-scikit-learn\">https://stackoverflow.com/questions/12237127/how-to-use-shuffle-in-kfold-in-scikit-learn</a></li>\n</ul>","frontmatter":{"title":"Cross Validation","date":"August 26, 2021"}}},"pageContext":{"slug":"/AI/cross-validation/","previous":{"fields":{"slug":"/AI/batch-normalization/"},"frontmatter":{"title":"Batch Normalization"}},"next":null}},"staticQueryHashes":["2486386679","3128451518"]}